# Kuan V, Denaxas S, Gonzalez-Izquierdo A, Direk K, Bhatti O, Husain S, Sutaria S, Hingorani M, Nitsch D, Parisinos C, Lumbers T, Mathur R, Sofat R, Casas JP, Wong I, Hemingway H, Hingorani A, 2024.

import sys, csv, re

codes = [{"code":"C108.12","system":"readv2"},{"code":"C10E.00","system":"readv2"},{"code":"C109.12","system":"readv2"},{"code":"C108.13","system":"readv2"},{"code":"C10F.00","system":"readv2"},{"code":"C109.13","system":"readv2"},{"code":"C10E.11","system":"readv2"},{"code":"C10F.11","system":"readv2"},{"code":"70766","system":"readv2"},{"code":"42762","system":"readv2"},{"code":"42729","system":"readv2"},{"code":"46301","system":"readv2"},{"code":"39070","system":"readv2"},{"code":"47650","system":"readv2"},{"code":"34268","system":"readv2"},{"code":"22884","system":"readv2"},{"code":"45919","system":"readv2"},{"code":"10692","system":"readv2"},{"code":"10418","system":"readv2"},{"code":"18230","system":"readv2"},{"code":"66145","system":"readv2"},{"code":"66872","system":"readv2"},{"code":"93468","system":"readv2"},{"code":"49869","system":"readv2"},{"code":"35385","system":"readv2"},{"code":"46150","system":"readv2"},{"code":"96235","system":"readv2"},{"code":"38161","system":"readv2"},{"code":"18209","system":"readv2"},{"code":"12736","system":"readv2"},{"code":"30323","system":"readv2"},{"code":"64668","system":"readv2"},{"code":"60699","system":"readv2"},{"code":"18642","system":"readv2"},{"code":"65267","system":"readv2"},{"code":"47315","system":"readv2"},{"code":"66965","system":"readv2"},{"code":"41049","system":"readv2"},{"code":"24458","system":"readv2"},{"code":"61829","system":"readv2"},{"code":"18143","system":"readv2"},{"code":"18278","system":"readv2"},{"code":"91943","system":"readv2"},{"code":"25591","system":"readv2"},{"code":"91646","system":"readv2"},{"code":"47816","system":"readv2"},{"code":"49655","system":"readv2"},{"code":"43227","system":"readv2"},{"code":"62352","system":"readv2"},{"code":"758","system":"readv2"},{"code":"47649","system":"readv2"},{"code":"37806","system":"readv2"},{"code":"62209","system":"readv2"},{"code":"98723","system":"readv2"},{"code":"51957","system":"readv2"},{"code":"43921","system":"readv2"},{"code":"24423","system":"readv2"},{"code":"55075","system":"readv2"},{"code":"26054","system":"readv2"},{"code":"63690","system":"readv2"},{"code":"98616","system":"readv2"},{"code":"62107","system":"readv2"},{"code":"62613","system":"readv2"},{"code":"93878","system":"readv2"},{"code":"47409","system":"readv2"},{"code":"18387","system":"readv2"},{"code":"18496","system":"readv2"},{"code":"65704","system":"readv2"},{"code":"64571","system":"readv2"},{"code":"67905","system":"readv2"},{"code":"49949","system":"readv2"},{"code":"12455","system":"readv2"},{"code":"45914","system":"readv2"},{"code":"12640","system":"readv2"},{"code":"68390","system":"readv2"},{"code":"61344","system":"readv2"},{"code":"60107","system":"readv2"},{"code":"53392","system":"readv2"},{"code":"97474","system":"readv2"},{"code":"18777","system":"readv2"},{"code":"17545","system":"readv2"},{"code":"30294","system":"readv2"},{"code":"1549","system":"readv2"},{"code":"44779","system":"readv2"},{"code":"57278","system":"readv2"},{"code":"49146","system":"readv2"},{"code":"21983","system":"readv2"},{"code":"17858","system":"readv2"},{"code":"24836","system":"readv2"},{"code":"55239","system":"readv2"},{"code":"45913","system":"readv2"},{"code":"54899","system":"readv2"},{"code":"42831","system":"readv2"},{"code":"18425","system":"readv2"},{"code":"17859","system":"readv2"},{"code":"47954","system":"readv2"},{"code":"48192","system":"readv2"},{"code":"40682","system":"readv2"},{"code":"60208","system":"readv2"},{"code":"49074","system":"readv2"},{"code":"40837","system":"readv2"},{"code":"47321","system":"readv2"},{"code":"18219","system":"readv2"},{"code":"47582","system":"readv2"},{"code":"69993","system":"readv2"},{"code":"25627","system":"readv2"},{"code":"95992","system":"readv2"},{"code":"34450","system":"readv2"},{"code":"22871","system":"readv2"},{"code":"44982","system":"readv2"},{"code":"95351","system":"readv2"},{"code":"32627","system":"readv2"},{"code":"63017","system":"readv2"},{"code":"58604","system":"readv2"},{"code":"69676","system":"readv2"},{"code":"50813","system":"readv2"},{"code":"1407","system":"readv2"},{"code":"46917","system":"readv2"},{"code":"35288","system":"readv2"},{"code":"61071","system":"readv2"},{"code":"56268","system":"readv2"},{"code":"49554","system":"readv2"},{"code":"85991","system":"readv2"},{"code":"91942","system":"readv2"},{"code":"51756","system":"readv2"},{"code":"59253","system":"readv2"},{"code":"54008","system":"readv2"},{"code":"59725","system":"readv2"},{"code":"93727","system":"readv2"},{"code":"36633","system":"readv2"},{"code":"18264","system":"readv2"},{"code":"97446","system":"readv2"},{"code":"18390","system":"readv2"},{"code":"50527","system":"readv2"},{"code":"70316","system":"readv2"},{"code":"50225","system":"readv2"},{"code":"97894","system":"readv2"},{"code":"62674","system":"readv2"},{"code":"60796","system":"readv2"},{"code":"68105","system":"readv2"},{"code":"18683","system":"readv2"},{"code":"95343","system":"readv2"},{"code":"46850","system":"readv2"},{"code":"N083","system":"readv2"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('diabetes-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["diabetes-mellitus---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["diabetes-mellitus---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["diabetes-mellitus---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
